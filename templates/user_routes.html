{% extends "base.html" %}
{% load i18n %}
{% block extrahead %}
{% if user.is_authenticated %}
<script type="text/javascript" src="{% url load-js 'poller' %}"></script>
{% endif %}
<script type="text/javascript" src="/static/js/jquery.dataTables.js"></script>
<script type="text/javascript">
	$(document).ready( function(){
		var noaction = readCookie('noaction');
		$( "#hide_noaction" ).button();
		if (noaction == 'true'){
			$('#hide_noaction').attr('checked','checked');
			$("#hide_noaction").button( "option", "label", "Show Expired, AdminInactive, Error" );
		}
		$("#hid_mid").val('');
		$('#dialog').dialog({
			height: 220,
            width: 300,
			modal: true,
			autoOpen: false,
			buttons: {
		'Delete': function() {
		route = $('#route_to_delete').text();
		route_url_id = '#del_route_'+route;
		url = $(route_url_id).attr('href');
			$.ajax({
			url: url ,
			cache: false,
			success: function(data) {
				$('#dialog').dialog('close');
				window.setTimeout('location.reload()', 1000);
			  }
		});
		},
		Cancel: function() {
			$('#dialog').dialog('close');
		},
		

	},
	close: function() {
        update_val = $("#hid_mid").val();
		if (update_val == 'UPDATED'){
			$("#hid_mid").val('');
			window.setTimeout('location.reload()', 500);
		}
    }
		});
		$('#console').dialog({
			height: 250,
            width: 800,
			modal: true,
			autoOpen: false,
			close: function() {
		        update_val = $("#hid_mid").val();
				if (update_val == 'UPDATED'){
					$("#hid_mid").val('');
					window.setTimeout('location.reload()', 500);
				}
		    }
		});
			
		$('#routes_table').dataTable({
			"bJQueryUI": true,
			"aoColumns": [ 
				{"bVisible": false, "bSearchable": false,"bSortable": false },
				{"bSearchable": true,"bSortable": true},
				{"bSearchable": true,"bSortable": true},
				{"bSearchable": true,"bSortable": true},
				{"bSearchable": true,"bSortable": true},
				{"bSearchable": true,"bSortable": true},
				{"bSearchable": true,"bSortable": true},
				{"bSearchable": true,"bSortable": true},
				{"bVisible": true, "bSearchable": false,"bSortable": false}
			],
			 "aaSorting": [[0,'desc']],
			"oLanguage": {
				"sLengthMenu": '{% trans "Display" %} <select><option value="25">25</option><option value="50">50</option><option value="-1">{% trans "All" %}</option></select> rules'
			},
			"iDisplayLength": 25,
	});
	$.fn.dataTableExt.afnFiltering = new Array();
	$.fn.dataTableExt.afnFiltering.push(
 	function( oSettings, aData, iDataIndex ) {
		// 4 here is the column where my statuses are.
 		var status_middle = $(aData[4]);
		var status = $(status_middle[0]).text();
 		if (( status == "EXPIRED" || status == "ADMININACTIVE" || status == "ERROR") && ($('#hide_noaction').attr('checked'))) {
 			return false;
 		}
		else {
			return true;
		}
 		
 	});
	var oTable = $('#routes_table').dataTable();
	oTable.fnDraw();
	$('#hide_noaction').change( function(){
			var noaction = $('#hide_noaction').attr('checked');
			if (noaction == true){
				$("#hide_noaction").button( "option", "label", "Show Expired, AdminInactive, Error" );
				}
			else{
				$("#hide_noaction").button( "option", "label", "Hide Expired, AdminInactive, Error" );
			}
			createCookie("noaction", noaction, 30);
			oTable.fnDraw(); 
		});
	
	$( ".button_place #routebutton" ).button({
            icons: {
                primary: "ui-icon-circle-plus"
            },
			});
		$( " .edit_button" ).button({
            icons: {
                primary: "ui-icon-wrench"
            },
			});
		$( " .del_button" ).button({
            icons: {
                primary: "ui-icon-circle-close"
            },
			})
			.click(function(){
				$('#dialog').dialog('open');
				return false;
			});
		$("#consolebutton").button({
            icons: {
                primary: "ui-icon-image"
            },
			})
			.click(function(){
				$("#consolebutton").stop().stop();
				$("#consolebutton").css('color', '#555555');
				$('#console').dialog('open');
				return false;
			});
			
		$(".expiresclass").tooltip();

		});
		
function delete_route(route){
	route_name = route;
	$('#route_to_delete').text(route_name);
	return false;
}		
		
		

</script>
<style type="text/css">
	#console {
		background: none repeat scroll 0 0 #36102a !important;
		color: #edeae8 !important;
		font-family: monospace !important;
	}
	.message {
		font-family: monospace !important;
	}
	.tooltip {
	display:none;
	background:transparent url(/static/black_arrow.png);
	font-size:12px;
	height:70px;
	width:160px;
	padding:25px;
	color:#fff;	
}
	
</style>
{% endblock %}
{% block title %}{% trans "My rules" %}{% endblock %}
{% block content %}
<div style="float:left">
	<h3 style="margin-top: 0px;">{% trans "My rules" %}</h3>
</div>
<div class='button_place' style="float:right">
	<button id="consolebutton">Console</button> <a href="{% url add-route %}" id="routebutton">Add Rule</a>
</div>
<br><br>
<table cellpadding="0" cellspacing="0" border="0" style="width:220px; clear:both;">
	<tbody>
		<tr>
			<td align="left"><input type="checkbox" id="hide_noaction" name="hide_noaction" value="Hide" /><label for="hide_noaction">Hide Expired, AdminInactive, Error</label></td>
		</tr>
	</tbody>
</table>
<br>
<table class="display" width="100%" id="routes_table">
<thead>
<tr>
	<th>Id</th>
	<th>{% trans "Name" %}</th>
	<th>{% trans "Match" %}</th>
	<th style="text-align: center;">{% trans "Then" %}</th>
	<th style="text-align: center; ">{% trans "Status" %}</th>
	{% comment %}<th style="text-align: center;">{% trans "Details" %}</th>{% endcomment %}
	<th style="text-align: center;">{% trans "Applier" %}</th>
	<th style="text-align: center;">{% trans "Expires" %}</th>
	<th style="text-align: center;">{% trans "Response" %}</th>
	<th style="text-align: center; width:180px;">{% trans "Actions" %}</th>
</tr>
</thead>

<tbody>
{% for route in routes %}

<tr class="GradeC" >
	<td>{{ route.pk }}</td>
	<td>{{ route.name }}</td>
	<td>{{ route.get_match|safe|escape }}</td>
	<td style="text-align: center;">{{route.get_then|safe|escape}}</td>
	<td style="text-align: center; ">
		<span 
		{% if route.days_to_expire %}
		class="expiresclass" 
		style="border-bottom:2px dashed red;" 
        title="Expires {% ifequal route.days_to_expire '0' %}today{% else%}in {{route.days_to_expire}} day{{ route.days_to_expire|pluralize }}{% endifequal %}"
		{% endif %}>{{route.status}}</span>
	</td>
	{% comment %}<td style="text-align: center;">{{ route.response }}</td>{% endcomment %}
	<td style="text-align: center;">{{ route.applier }}</td>
	<td style="text-align: center;">{{ route.expires }}</td>
	<td style="text-align: center;">{{ route.response }}</td>
	<td style="text-align: center; width:180px;">
		{% ifequal route.status 'ACTIVE' %}
		<a href="{% url edit-route route.name %}" class="edit_button" id="edit_button_{{route.pk}}">Edit</a> 
		<button class="del_button" id="{{route.name}}" onclick="javascript:delete_route(this.id)">Del</button>
		<a href="{% url delete-route route.name %}" style="display:none" id="del_route_{{route.name}}"></a>
		{% else %}
		{% ifequal route.status 'INACTIVE' %}
		<a href="{% url edit-route route.name %}" class="edit_button" id="edit_button_{{route.pk}}">Reactivate</a>
		{% else %}
		{% ifequal route.status 'OUTOFSYNC' %}
		<a href="{% url edit-route route.name %}" class="edit_button" id="edit_button_{{route.pk}}">ReSync</a>
		{% else %}
		-
		{% endifequal %}
		{% endifequal %}
		{% endifequal %}
		</td>
</tr>

{% endfor %}
</tbody>
</table>

<div id="dialog" title="Delete Route">
		<p>You are about to delete rule <strong><span id="route_to_delete"></span></strong></p>
		<p>Deleting the rule will automatically remove the configuration from the network and mark this route as inactive.</p>
		<p>Are you sure you want to proceed?</p>
</div>
<div id="console" title="Console">
					{% include "poll.html" %}
</div>
{% endblock %}
